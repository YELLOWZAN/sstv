{% extends "base.html" %}

{% block styles %}
<style>
    .file-upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .file-upload-area:hover,
            .file-upload-area.drag-over {
                border-color: #007bff;
                background-color: #f8f9ff;
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 123, 255, 0.1);
            }
            
            /* Toast notification styles */
            .toast {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: opacity 0.3s ease, transform 0.3s ease;
            }
            
            .toast.show {
                opacity: 1;
                transform: translateX(0);
            }
            
            .toast-success {
                background-color: #28a745;
            }
            
            .toast-error {
                background-color: #dc3545;
            }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="page-title">
        <h1>{% if mode == 'encryption' %}åŠ å¯†å›¾åƒä¸ºSSTVéŸ³é¢‘{% else %}ä»SSTVéŸ³é¢‘è§£å¯†å›¾åƒ{% endif %}</h1>
        <p>
            {% if mode == 'encryption' %}
                ä¸Šä¼ å›¾åƒæ–‡ä»¶ï¼Œé€‰æ‹©SSTVæ¨¡å¼ï¼Œæˆ‘ä»¬å°†å¸®æ‚¨ç”Ÿæˆå¯ä¼ è¾“çš„éŸ³é¢‘æ–‡ä»¶
            {% else %}
                ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶æˆ–ä½¿ç”¨éº¦å…‹é£å½•åˆ¶ï¼Œæˆ‘ä»¬å°†è‡ªåŠ¨æ£€æµ‹SSTVä¿¡å·å¹¶è¿˜åŸå›¾åƒ
            {% endif %}
        </p>
    </div>

    <!-- ä¸»åŠŸèƒ½åŒº -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
        <div class="card">
            <div class="card-title">
                {% if mode == 'encryption' %}<i class="fa fa-image"></i>ä¸Šä¼ å›¾åƒ{% else %}<i class="fa fa-volume-up"></i>éŸ³é¢‘è¾“å…¥{% endif %}
            </div>
            
            {% if mode == 'encryption' %}
                <!-- åŠ å¯†æ¨¡å¼è¾“å…¥åŒº -->
                <form id="encryption-form" enctype="multipart/form-data">
                    <!-- æ–‡ä»¶ä¸Šä¼  -->
                    <div class="form-group">
                        <label for="image-upload" class="form-label">é€‰æ‹©å›¾åƒæ–‡ä»¶</label>
                        <div class="file-upload-area" onclick="document.getElementById('image-upload').click()">
                            <input id="image-upload" name="image_file" type="file" accept="image/*" class="hidden">
                            <div class="file-upload-icon">ğŸ“·</div>
                            <div class="file-upload-text">ç‚¹å‡»æˆ–æ‹–æ”¾å›¾åƒæ–‡ä»¶åˆ°æ­¤å¤„</div>
                            <div class="file-upload-hint">PNG, JPG æˆ– BMP (æœ€å¤§ 10MB)</div>
                        </div>
                        <div id="image-preview" class="mt-3 hidden">
                            <img id="preview-img" src="" alt="é¢„è§ˆ" class="preview-image">
                        </div>
                    </div>

                    <!-- SSTVæ¨¡å¼é€‰æ‹© -->
                    <div class="form-group">
                        <label for="sstv-mode" class="form-label">é€‰æ‹©SSTVæ¨¡å¼</label>
                        <select id="sstv-mode" name="mode_id" class="form-control">
                            <option value="10">PD90 (é»˜è®¤)</option>
                            <!-- å…¶ä»–æ¨¡å¼å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                        <div class="form-hint">
                            æ¨èï¼šç‚¹å‡»ä¸Šæ–¹çš„æ™ºèƒ½æ¨èæŒ‰é’®è·å–æœ€é€‚åˆæ‚¨å›¾åƒçš„æ¨¡å¼
                        </div>
                    </div>

                    <!-- æ¨èæ¨¡å¼æç¤º -->
                    <div id="recommended-mode" class="recommended-mode hidden">
                        <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="button-group">
                        <button type="button" id="recommend-mode-btn" class="btn btn-outline">
                            <i class="fa fa-magic mr-1"></i> æ™ºèƒ½æ¨èæ¨¡å¼
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-cog mr-1"></i> å¼€å§‹åŠ å¯†
                        </button>
                    </div>
                </form>
            {% else %}
                <!-- è§£å¯†æ¨¡å¼è¾“å…¥åŒº -->
                <div>
                    <!-- æ–‡ä»¶ä¸Šä¼ é€‰é¡¹ -->
                    <div class="form-group border-b">
                        <h3 class="section-title">æ–‡ä»¶ä¸Šä¼ </h3>
                        <form id="audio-upload-form" enctype="multipart/form-data">
                            <div class="file-upload-area" onclick="document.getElementById('audio-upload').click()">
                                <input id="audio-upload" name="audio_file" type="file" accept="audio/*" class="hidden">
                                <div class="file-upload-icon">ğŸµ</div>
                                <div class="file-upload-text">ç‚¹å‡»ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶</div>
                                <div class="file-upload-hint">WAV, MP3 æˆ–å…¶ä»–éŸ³é¢‘æ ¼å¼ (æœ€å¤§ 50MB)</div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fa fa-file-text-o mr-1"></i> ä»æ–‡ä»¶è§£å¯†
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- éº¦å…‹é£å½•åˆ¶é€‰é¡¹ -->
                    <div class="form-group">
                        <h3 class="section-title">éº¦å…‹é£å½•åˆ¶</h3>
                        <form id="mic-record-form">
                            <div class="form-group">
                                <label for="record-duration" class="form-label">å½•åˆ¶æ—¶é•¿ (ç§’)</label>
                                <input type="number" id="record-duration" name="duration" min="5" max="60" value="10" class="form-control">
                            </div>
                            <div class="button-group">
                                <button type="button" id="start-record-btn" class="btn btn-accent">
                                    <i class="fa fa-microphone mr-1"></i> å¼€å§‹å½•éŸ³
                                </button>
                                <button type="button" id="stop-record-btn" class="btn btn-danger hidden">
                                    <i class="fa fa-stop mr-1"></i> åœæ­¢å½•éŸ³
                                </button>
                            </div>
                            <div id="recording-status" class="recording-indicator hidden">
                                <span class="recording-dot"></span>
                                æ­£åœ¨å½•éŸ³...
                            </div>
                            <div id="record-timer" class="record-timer">00:00</div>
                        </form>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- å³ä¾§ï¼šè¾“å‡ºå’Œè¿›åº¦åŒºåŸŸ -->
        <div class="card">
            <div class="card-title">
                {% if mode == 'encryption' %}<i class="fa fa-music"></i>ç”Ÿæˆç»“æœ{% else %}<i class="fa fa-picture-o"></i>è§£å¯†ç»“æœ{% endif %}
            </div>
            
            <!-- è¿›åº¦å¡ç‰‡ -->
            <div id="progress-card" class="progress-card">
                <div class="progress-header">
                    <h3>å¤„ç†è¿›åº¦</h3>
                    <span id="progress-status">ç­‰å¾…å¼€å§‹</span>
                </div>
                <div class="progress">
                    <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div id="progress-message" class="progress-message">
                    å‡†å¤‡å°±ç»ªï¼Œè¯·å¼€å§‹ä¸Šä¼ æ–‡ä»¶
                </div>
            </div>

            <!-- ç»“æœé¢„è§ˆåŒº -->
            <div id="result-preview" class="result-preview hidden">
                {% if mode == 'encryption' %}
                    <!-- éŸ³é¢‘é¢„è§ˆ -->
                    <div class="result-section">
                        <h3 class="section-title">éŸ³é¢‘é¢„è§ˆ</h3>
                        <div class="audio-preview">
                            <audio id="audio-player" class="audio-player" controls></audio>
                        </div>
                    </div>
                {% else %}
                    <!-- å›¾åƒé¢„è§ˆ -->
                    <div class="result-section">
                        <h3 class="section-title">å›¾åƒé¢„è§ˆ</h3>
                        <div class="image-preview">
                            <img id="decoded-image" src="" alt="è§£å¯†åçš„å›¾åƒ" class="result-image">
                        </div>
                    </div>
                {% endif %}
                
                <!-- ç»“æœä¿¡æ¯ -->
                <div class="result-info">
                    <div id="result-info" class="info-content">
                        <!-- ç»“æœä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
                
                <!-- ä¸‹è½½æŒ‰é’® -->
                <a id="download-btn" href="" class="btn btn-success btn-block" download>
                    <i class="fa fa-download mr-1"></i> ä¸‹è½½æ–‡ä»¶
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const mode = '{{ mode }}';
    
    // åŠ è½½SSTVæ¨¡å¼æ•°æ®ï¼ˆä»…åœ¨åŠ å¯†æ¨¡å¼ä¸‹ï¼‰
    if (mode === 'encryption') {
        fetch('/api/encryption/get_modes')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modeSelect = document.getElementById('sstv-mode');
                    modeSelect.innerHTML = '';
                    data.modes.forEach(m => {
                        const option = document.createElement('option');
                        option.value = m.id;
                        option.textContent = `${m.name} (${m.description})`;
                        if (m.id === 10) option.selected = true;
                        modeSelect.appendChild(option);
                    });
                }
            });
        
        // æ‹–æ”¾åŠŸèƒ½ï¼ˆåŠ å¯†æ¨¡å¼ï¼‰
        const fileUploadArea = document.querySelector('.file-upload-area');
        if (fileUploadArea) {
            // é˜²æ­¢é»˜è®¤æ‹–æ”¾è¡Œä¸º
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            // é«˜äº®æ‹–æ”¾åŒºåŸŸ
            ['dragenter', 'dragover'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                fileUploadArea.addEventListener(eventName, unhighlight, false);
            });

            // å¤„ç†æ‹–æ”¾çš„æ–‡ä»¶
            fileUploadArea.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            fileUploadArea.classList.add('drag-over');
        }

        function unhighlight() {
            fileUploadArea.classList.remove('drag-over');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                if (mode === 'encryption' && files[0].type.startsWith('image/')) {
                    document.getElementById('image-upload').files = files;
                    handleFilePreview(files[0], 'image');
                } else if (mode === 'decryption' && files[0].type.startsWith('audio/')) {
                    document.getElementById('audio-upload').files = files;
                }
            }
        }

        // æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        function handleFilePreview(file, type) {
            if (type === 'image') {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const preview = document.getElementById('image-preview');
                    const img = document.getElementById('preview-img');
                    img.src = event.target.result;
                    preview.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        // å›¾åƒé¢„è§ˆåŠŸèƒ½
        document.getElementById('image-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleFilePreview(file, 'image');
            }
        });
        
        // éŸ³é¢‘é¢„è§ˆåŠŸèƒ½ (åœ¨è§£å¯†æ¨¡å¼ä¸‹)
        if (mode === 'decryption') {
            document.getElementById('audio-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.type.startsWith('audio/')) {
                    // æ£€æŸ¥DOMä¸­æ˜¯å¦å·²å­˜åœ¨éŸ³é¢‘é¢„è§ˆå…ƒç´ 
                    const audioPreviewContainer = document.createElement('div');
                    audioPreviewContainer.id = 'audio-preview';
                    audioPreviewContainer.className = 'mt-3';
                    
                    const audioPlayer = document.createElement('audio');
                    audioPlayer.id = 'preview-audio';
                    audioPlayer.className = 'audio-player';
                    audioPlayer.controls = true;
                    
                    // åˆ›å»ºä¸€ä¸ªå¯¹è±¡URLæŒ‡å‘ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶
                    const objectURL = URL.createObjectURL(file);
                    audioPlayer.src = objectURL;
                    
                    // å°†éŸ³é¢‘æ’­æ”¾å™¨æ·»åŠ åˆ°å®¹å™¨
                    audioPreviewContainer.appendChild(audioPlayer);
                    
                    // å°†é¢„è§ˆå®¹å™¨æ·»åŠ åˆ°æ–‡ä»¶ä¸Šä¼ åŒºåŸŸä¹‹å
                    const fileUploadArea = document.querySelector('.file-upload-area');
                    // å…ˆç§»é™¤å¯èƒ½å·²å­˜åœ¨çš„é¢„è§ˆ
                    const existingPreview = document.getElementById('audio-preview');
                    if (existingPreview) {
                        existingPreview.remove();
                    }
                    fileUploadArea.parentNode.appendChild(audioPreviewContainer);
                    
                    // å½“ç»„ä»¶å¸è½½æ—¶é‡Šæ”¾URL
                    audioPlayer.onload = function() {
                        URL.revokeObjectURL(objectURL);
                    }
                }
            });
        }
        
        // æ™ºèƒ½æ¨èæ¨¡å¼
        document.getElementById('recommend-mode-btn').addEventListener('click', function() {
            const imageFile = document.getElementById('image-upload').files[0];
            if (!imageFile) {
                alert('è¯·å…ˆä¸Šä¼ å›¾åƒæ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('image_file', imageFile);
            
            updateProgress(0, 'æ­£åœ¨åˆ†æå›¾åƒç‰¹å¾...');
            
            fetch('/api/encryption/get_recommended_mode', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modeSelect = document.getElementById('sstv-mode');
                    // éå†é€‰é¡¹æ‰¾åˆ°å¯¹åº”çš„æ¨¡å¼ä»£ç 
                    for (let i = 0; i < modeSelect.options.length; i++) {
                        if (modeSelect.options[i].getAttribute('data-code') === data.recommended_mode || 
                            modeSelect.options[i].value === data.recommended_mode) {
                            modeSelect.selectedIndex = i;
                            break;
                        }
                    }
                    showSuccess(`å·²æ¨èæœ€é€‚åˆçš„æ¨¡å¼`);
                    updateProgress(100, 'æ¨èå®Œæˆ');
                } else {
                    handleError(data.error);
                    updateProgress(0, 'æ¨èå¤±è´¥');
                }
            })
            .catch(error => {
                handleError('æ¨èæ¨¡å¼æ—¶å‡ºé”™');
                updateProgress(0, 'æ¨èå¤±è´¥');
            });
        });
        
        // åŠ å¯†è¡¨å•æäº¤
        document.getElementById('encryption-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const imageFile = document.getElementById('image-upload').files[0];
            const modeSelect = document.getElementById('sstv-mode');
            const selectedOption = modeSelect.options[modeSelect.selectedIndex];
            const modeName = selectedOption.getAttribute('data-code') || selectedOption.value;
            
            if (!imageFile) {
                alert('è¯·å…ˆä¸Šä¼ å›¾åƒæ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('image_file', imageFile);
            formData.append('mode', modeName);
            
            updateProgress(10, 'æ­£åœ¨ä¸Šä¼ å›¾åƒ...');
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            const progressInterval = setInterval(() => {
                const currentProgress = parseInt(document.getElementById('progress-bar').style.width);
                if (currentProgress < 50) {
                    updateProgress(currentProgress + 10, 'æ­£åœ¨å¤„ç†å›¾åƒ...');
                }
            }, 300);
            
            fetch('/api/encryption/encode_image', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                
                if (data.success) {
                    updateProgress(100, 'åŠ å¯†å®Œæˆ');
                    
                    // æ›´æ–°ç»“æœé¢„è§ˆ
                    const audioPlayer = document.getElementById('audio-player');
                    audioPlayer.src = data.audio_url;
                    
                    // æ›´æ–°ç»“æœä¿¡æ¯
                    document.getElementById('result-info').innerHTML = `
                        <div><strong>æ–‡ä»¶å:</strong> ${data.audio_path}</div>
                        <div><strong>SSTVæ¨¡å¼:</strong> ${data.mode}</div>
                        <div><strong>çŠ¶æ€:</strong> åŠ å¯†æˆåŠŸ</div>
                    `;
                    
                    // æ›´æ–°ä¸‹è½½æŒ‰é’®
                    document.getElementById('download-btn').href = data.audio_url;
                    document.getElementById('download-btn').download = data.audio_path;
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    document.getElementById('result-preview').classList.remove('hidden');
                    
                    showSuccess('å›¾åƒåŠ å¯†æˆåŠŸï¼');
                } else {
                    handleError(data.error);
                    updateProgress(0, 'åŠ å¯†å¤±è´¥');
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                handleError('åŠ å¯†è¿‡ç¨‹ä¸­å‡ºé”™');
                updateProgress(0, 'åŠ å¯†å¤±è´¥');
            });
        });
    }
    
    // è§£å¯†æ¨¡å¼åŠŸèƒ½
    if (mode === 'decryption') {
        // éŸ³é¢‘æ–‡ä»¶ä¸Šä¼ è§£å¯†
        document.getElementById('audio-upload-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const audioFile = document.getElementById('audio-upload').files[0];
            if (!audioFile) {
                alert('è¯·å…ˆä¸Šä¼ éŸ³é¢‘æ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('audio_file', audioFile);
            
            updateProgress(10, 'æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...');
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            const progressInterval = setInterval(() => {
                const currentProgress = parseInt(document.getElementById('progress-bar').style.width);
                if (currentProgress < 70) {
                    updateProgress(currentProgress + 10, 'æ­£åœ¨å¤„ç†éŸ³é¢‘ä¿¡å·...');
                }
            }, 500);
            
            fetch('/api/decryption/decode_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                
                if (data.success) {
                    updateProgress(100, 'è§£å¯†å®Œæˆ');
                    
                    // æ›´æ–°ç»“æœé¢„è§ˆ
                    const decodedImage = document.getElementById('decoded-image');
                    decodedImage.src = data.image_url;
                    
                    // æ›´æ–°ç»“æœä¿¡æ¯
                    document.getElementById('result-info').innerHTML = `
                        <div><strong>æ–‡ä»¶å:</strong> ${data.image_path}</div>
                        <div><strong>æ£€æµ‹åˆ°çš„SSTVæ¨¡å¼:</strong> ${data.mode}</div>
                        <div><strong>çŠ¶æ€:</strong> è§£å¯†æˆåŠŸ</div>
                    `;
                    
                    // æ›´æ–°ä¸‹è½½æŒ‰é’®
                    document.getElementById('download-btn').href = data.image_url;
                    document.getElementById('download-btn').download = data.image_path;
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    document.getElementById('result-preview').classList.remove('hidden');
                    
                    showSuccess('éŸ³é¢‘è§£å¯†æˆåŠŸï¼');
                } else {
                    handleError(data.error);
                    updateProgress(0, 'è§£å¯†å¤±è´¥');
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                handleError('è§£å¯†è¿‡ç¨‹ä¸­å‡ºé”™');
                updateProgress(0, 'è§£å¯†å¤±è´¥');
            });
        });
        
        // éº¦å…‹é£å½•åˆ¶åŠŸèƒ½
        let mediaRecorder = null;
        let audioChunks = [];
        
        document.getElementById('start-record-btn').addEventListener('click', function() {
            const duration = document.getElementById('record-duration').value;
            
            // è¯·æ±‚éº¦å…‹é£æƒé™
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    // æ›´æ–°UIçŠ¶æ€
                    this.classList.add('hidden');
                    document.getElementById('stop-record-btn').classList.remove('hidden');
                    document.getElementById('recording-status').classList.remove('hidden');
                    
                    // åˆå§‹åŒ–MediaRecorder
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.addEventListener('dataavailable', event => {
                        audioChunks.push(event.data);
                    });
                    
                    mediaRecorder.addEventListener('stop', () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        processRecordedAudio(audioBlob);
                    });
                    
                    // å¼€å§‹å½•éŸ³
                    mediaRecorder.start();
                    updateProgress(10, `æ­£åœ¨å½•éŸ³ ${duration} ç§’...`);
                    
                    // è®¾ç½®è‡ªåŠ¨åœæ­¢
                    setTimeout(() => {
                        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                            stopRecording();
                        }
                    }, duration * 1000);
                })
                .catch(error => {
                    handleError('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                });
        });
        
        document.getElementById('stop-record-btn').addEventListener('click', stopRecording);
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                
                // æ›´æ–°UIçŠ¶æ€
                document.getElementById('start-record-btn').classList.remove('hidden');
                document.getElementById('stop-record-btn').classList.add('hidden');
                document.getElementById('recording-status').classList.add('hidden');
                
                updateProgress(50, 'æ­£åœ¨å¤„ç†å½•éŸ³...');
            }
        }
        
        function processRecordedAudio(audioBlob) {
            // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶å¹¶ä¸Šä¼ 
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'recorded_audio.wav');
            formData.append('from_mic', 'true');
            
            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            const progressInterval = setInterval(() => {
                const currentProgress = parseInt(document.getElementById('progress-bar').style.width);
                if (currentProgress < 90) {
                    updateProgress(currentProgress + 5, 'æ­£åœ¨åˆ†æéŸ³é¢‘ä¿¡å·...');
                }
            }, 300);
            
            fetch('/api/decryption/decode_audio', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                clearInterval(progressInterval);
                
                if (data.success) {
                    updateProgress(100, 'è§£å¯†å®Œæˆ');
                    
                    // æ›´æ–°ç»“æœé¢„è§ˆ
                    const decodedImage = document.getElementById('decoded-image');
                    decodedImage.src = data.image_url;
                    
                    // æ›´æ–°ç»“æœä¿¡æ¯
                    document.getElementById('result-info').innerHTML = `
                        <div><strong>æ–‡ä»¶å:</strong> ${data.image_path}</div>
                        <div><strong>æ£€æµ‹åˆ°çš„SSTVæ¨¡å¼:</strong> ${data.mode}</div>
                        <div><strong>çŠ¶æ€:</strong> è§£å¯†æˆåŠŸ</div>
                    `;
                    
                    // æ›´æ–°ä¸‹è½½æŒ‰é’®
                    document.getElementById('download-btn').href = data.image_url;
                    document.getElementById('download-btn').download = data.image_path;
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    document.getElementById('result-preview').classList.remove('hidden');
                    
                    showSuccess('å½•éŸ³è§£å¯†æˆåŠŸï¼');
                } else {
                    handleError(data.error);
                    updateProgress(0, 'è§£å¯†å¤±è´¥');
                }
            })
            .catch(error => {
                clearInterval(progressInterval);
                handleError('å¤„ç†å½•éŸ³è¿‡ç¨‹ä¸­å‡ºé”™');
                updateProgress(0, 'è§£å¯†å¤±è´¥');
            });
        }
    }
    
    // è¿›åº¦æ›´æ–°å‡½æ•°
    function updateProgress(percent, message) {
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-status').textContent = `${percent}%`;
        document.getElementById('progress-message').textContent = message;
    }
    
    function showSuccess(message) {
        const toast = document.createElement('div');
        toast.className = 'toast toast-success';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
    
    function handleError(errorMessage) {
        console.error('Error:', errorMessage);
        const toast = document.createElement('div');
        toast.className = 'toast toast-error';
        toast.textContent = errorMessage || 'æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}