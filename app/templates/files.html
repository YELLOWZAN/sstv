{% extends "base.html" %}

{% block head %}
<style>
    .file-card {
        transition: all 0.2s ease;
    }
    .file-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    .file-checkbox {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 页面标题 -->
    <div class="page-header">
        <h1 class="page-title">文件管理</h1>
        <p class="page-description">管理您的图像和音频文件</p>
    </div>
        
        <!-- 批量操作工具栏 -->
    <div id="batch-actions" class="hidden batch-actions-toolbar">
        <span id="selected-count" class="selected-count">已选择: 0</span>
        <div class="batch-action-buttons">
            <button id="batch-delete-btn" class="btn btn-danger">
                <i class="fa fa-trash mr-1"></i> 批量删除
            </button>
            <button id="cancel-selection-btn" class="btn btn-outline">
                取消
            </button>
        </div>
    </div>
    </div>

    <!-- 筛选和搜索 -->
    <div class="toolbar">
        <!-- 文件类型筛选 -->
        <div class="filter-buttons">
            <button id="filter-all" class="filter-btn filter-btn-active">
                全部文件
            </button>
            <button id="filter-images" class="filter-btn">
                <i class="fa fa-image mr-1"></i> 图像文件
            </button>
            <button id="filter-audios" class="filter-btn">
                <i class="fa fa-volume-up mr-1"></i> 音频文件
            </button>
        </div>
        
        <!-- 搜索框 -->
        <div class="search-container">
            <i class="search-icon fa fa-search"></i>
            <input type="text" id="file-search" class="search-input" placeholder="搜索文件名...">
        </div>
    </div>

    <!-- 批量选择切换 -->
    <div class="flex justify-between items-center">
        <div class="text-sm text-gray-500">
            <span id="total-files-count">0</span> 个文件
        </div>
        <button id="toggle-selection-btn" class="text-sm text-primary hover:text-blue-600 flex items-center">
            <i class="fa fa-check-square-o mr-1"></i>
            <span>开启批量选择</span>
        </button>
    </div>

    <!-- 文件列表 -->
    <div id="files-container" class="file-grid">
        <!-- 文件加载状态 -->
        <div id="loading-indicator" class="loading-placeholder">
            <div class="loading-spinner"></div>
            <p>正在加载文件...</p>
        </div>
        
        <!-- 空状态提示 -->
        <div id="empty-state" class="col-span-full py-12 text-center hidden">
            <i class="fa fa-folder-open text-5xl text-gray-300 mb-4"></i>
            <p class="text-gray-500">没有找到文件</p>
        </div>
        
        <!-- 文件卡片将通过JavaScript动态生成 -->
    </div>

    <!-- 分页控制 -->
    <div id="pagination" class="pagination-container hidden">
        <button id="prev-page" class="btn btn-outline" disabled>
            <i class="fa fa-chevron-left mr-1"></i> 上一页
        </button>
        <div class="page-info">
            第 <span id="current-page">1</span> 页，共 <span id="total-pages">1</span> 页
        </div>
        <button id="next-page" class="btn btn-outline" disabled>
            下一页 <i class="fa fa-chevron-right ml-1"></i>
        </button>
    </div>
</div>

<!-- 确认删除对话框 -->
<div id="delete-modal" class="modal hidden">
    <div class="modal-content">
        <h3 class="modal-title">确认删除</h3>
        <p id="delete-message" class="modal-message">
            您确定要删除此文件吗？此操作无法撤销。
        </p>
        <div class="modal-actions">
            <button id="cancel-delete-btn" class="btn btn-outline">
                取消
            </button>
            <button id="confirm-delete-btn" class="btn btn-danger">
                确认删除
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 文件数据和状态
    let files = [];
    let filteredFiles = [];
    let currentFilter = 'all';
    let searchQuery = '';
    let isSelectionMode = false;
    let selectedFiles = [];
    let currentPage = 1;
    const itemsPerPage = 12;
    
    // 待删除的文件信息
    let deleteFileInfo = null;
    let isBatchDelete = false;
    
    // 初始化页面
    document.addEventListener('DOMContentLoaded', function() {
        loadFiles();
        initEventListeners();
    });
    
    // 加载文件列表
    function loadFiles() {
        document.getElementById('loading-indicator').classList.remove('hidden');
        document.getElementById('empty-state').classList.add('hidden');
        
        fetch(`/api/files?type=${currentFilter}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading-indicator').classList.add('hidden');
                
                if (data.success) {
                    files = data.files;
                    applyFilters();
                    updateFileCount();
                } else {
                    handleError('加载文件失败');
                }
            })
            .catch(error => {
                document.getElementById('loading-indicator').classList.add('hidden');
                handleError('加载文件时出错');
            });
    }
    
    // 应用筛选器
    function applyFilters() {
        filteredFiles = files;
        
        // 应用搜索筛选
        if (searchQuery) {
            filteredFiles = filteredFiles.filter(file => 
                file.name.toLowerCase().includes(searchQuery.toLowerCase())
            );
        }
        
        // 重置当前页码
        currentPage = 1;
        
        // 渲染文件列表
        renderFileList();
        
        // 更新分页控制
        updatePagination();
        
        // 更新空状态
        document.getElementById('empty-state').classList.toggle('hidden', filteredFiles.length > 0);
    }
    
    // 渲染文件列表
    function renderFileList() {
        const container = document.getElementById('files-container');
        container.innerHTML = '';
        
        // 计算当前页显示的文件
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentPageFiles = filteredFiles.slice(startIndex, endIndex);
        
        currentPageFiles.forEach(file => {
            const card = createFileCard(file);
            container.appendChild(card);
        });
    }
    
    // 创建文件卡片
    function createFileCard(file) {
        const card = document.createElement('div');
        card.className = 'file-card bg-white rounded-lg shadow overflow-hidden relative';
        card.dataset.filename = file.name;
        card.dataset.folder = file.folder;
        
        // 卡片内容
        let cardContent = '';
        
        if (file.type === 'image') {
            // 图像文件卡片
            cardContent = `
                <div class="aspect-w-1 aspect-h-1 overflow-hidden bg-gray-100">
                    <img src="/api/download_file/${file.folder}/${file.name}" alt="${file.name}" class="object-cover w-full h-48">
                </div>
                <div class="p-4">
                    <div class="font-medium text-gray-900 truncate mb-1">${file.name}</div>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>${file.formatted_time}</span>
                        <span>${file.formatted_size}</span>
                    </div>
                    <div class="mt-3 flex justify-between">
                        <a href="/api/download_file/${file.folder}/${file.name}" download class="text-primary hover:text-blue-600 text-sm flex items-center">
                            <i class="fa fa-download mr-1"></i> 下载
                        </a>
                        <button class="delete-btn text-red-500 hover:text-red-700 text-sm flex items-center" data-filename="${file.name}" data-folder="${file.folder}">
                            <i class="fa fa-trash mr-1"></i> 删除
                        </button>
                    </div>
                </div>
            `;
        } else if (file.type === 'audio') {
            // 音频文件卡片
            cardContent = `
                <div class="aspect-w-1 aspect-h-1 overflow-hidden bg-gray-100 flex items-center justify-center">
                    <div class="text-center p-4">
                        <i class="fa fa-volume-up text-4xl text-primary mb-2"></i>
                        <div class="text-xs text-gray-500">音频文件</div>
                    </div>
                </div>
                <div class="p-4">
                    <div class="font-medium text-gray-900 truncate mb-1">${file.name}</div>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>${file.formatted_time}</span>
                        <span>${file.formatted_size}</span>
                    </div>
                    <div class="mt-2">
                        <audio controls class="w-full h-8"><source src="/api/download_file/${file.folder}/${file.name}" type="audio/wav"></audio>
                    </div>
                    <div class="mt-3 flex justify-between">
                        <a href="/api/download_file/${file.folder}/${file.name}" download class="text-primary hover:text-blue-600 text-sm flex items-center">
                            <i class="fa fa-download mr-1"></i> 下载
                        </a>
                        <button class="delete-btn text-red-500 hover:text-red-700 text-sm flex items-center" data-filename="${file.name}" data-folder="${file.folder}">
                            <i class="fa fa-trash mr-1"></i> 删除
                        </button>
                    </div>
                </div>
            `;
        }
        
        card.innerHTML = cardContent;
        
        // 添加复选框（用于批量选择）
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'file-checkbox h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary hidden';
        checkbox.dataset.filename = file.name;
        checkbox.dataset.folder = file.folder;
        
        checkbox.addEventListener('change', function() {
            const fileInfo = {
                filename: this.dataset.filename,
                folder: this.dataset.folder
            };
            
            if (this.checked) {
                selectedFiles.push(fileInfo);
                card.classList.add('ring-2', 'ring-primary');
            } else {
                selectedFiles = selectedFiles.filter(f => !(f.filename === fileInfo.filename && f.folder === fileInfo.folder));
                card.classList.remove('ring-2', 'ring-primary');
            }
            
            updateSelectedCount();
        });
        
        card.appendChild(checkbox);
        
        // 添加删除按钮事件监听
        const deleteBtn = card.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', function() {
            deleteFileInfo = {
                filename: this.dataset.filename,
                folder: this.dataset.folder
            };
            isBatchDelete = false;
            showDeleteModal(false);
        });
        
        // 更新选择模式
        updateSelectionMode(card, checkbox);
        
        return card;
    }
    
    // 更新选择模式显示
    function updateSelectionMode(card, checkbox) {
        if (isSelectionMode) {
            checkbox.classList.remove('hidden');
        } else {
            checkbox.classList.add('hidden');
            checkbox.checked = false;
            card.classList.remove('ring-2', 'ring-primary');
        }
    }
    
    // 更新分页控制
    function updatePagination() {
        const totalPages = Math.ceil(filteredFiles.length / itemsPerPage);
        const pagination = document.getElementById('pagination');
        
        if (totalPages <= 1) {
            pagination.classList.add('hidden');
            return;
        }
        
        pagination.classList.remove('hidden');
        
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        
        // 启用/禁用分页按钮
        document.getElementById('prev-page').disabled = currentPage <= 1;
        document.getElementById('next-page').disabled = currentPage >= totalPages;
    }
    
    // 更新文件计数
    function updateFileCount() {
        document.getElementById('total-files-count').textContent = files.length;
    }
    
    // 更新已选择文件计数
    function updateSelectedCount() {
        const countElement = document.getElementById('selected-count');
        countElement.textContent = `已选择: ${selectedFiles.length}`;
        
        // 启用/禁用批量删除按钮
        document.getElementById('batch-delete-btn').disabled = selectedFiles.length === 0;
    }
    
    // 显示删除确认对话框
    function showDeleteModal(isBatch) {
        const modal = document.getElementById('delete-modal');
        const messageElement = document.getElementById('delete-message');
        
        if (isBatch) {
            messageElement.textContent = `您确定要删除选中的 ${selectedFiles.length} 个文件吗？此操作无法撤销。`;
        } else if (deleteFileInfo) {
            messageElement.textContent = `您确定要删除文件 "${deleteFileInfo.filename}" 吗？此操作无法撤销。`;
        }
        
        modal.classList.remove('hidden');
    }
    
    // 隐藏删除确认对话框
    function hideDeleteModal() {
        document.getElementById('delete-modal').classList.add('hidden');
        deleteFileInfo = null;
        isBatchDelete = false;
    }
    
    // 删除单个文件
    function deleteSingleFile() {
        if (!deleteFileInfo) return;
        
        fetch('/api/delete_file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(deleteFileInfo)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 从列表中移除文件
                files = files.filter(file => !(file.name === deleteFileInfo.filename && file.folder === deleteFileInfo.folder));
                applyFilters();
                updateFileCount();
                showSuccess('文件删除成功');
            } else {
                handleError('文件删除失败: ' + data.error);
            }
        })
        .catch(error => {
            handleError('删除文件时出错');
        })
        .finally(() => {
            hideDeleteModal();
        });
    }
    
    // 批量删除文件
    function deleteMultipleFiles() {
        if (selectedFiles.length === 0) return;
        
        fetch('/api/batch_delete_files', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ files: selectedFiles })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 从列表中移除已删除的文件
                selectedFiles.forEach(fileInfo => {
                    files = files.filter(file => !(file.name === fileInfo.filename && file.folder === fileInfo.folder));
                });
                
                // 重置选择状态
                selectedFiles = [];
                isSelectionMode = false;
                updateBatchActionsUI();
                
                applyFilters();
                updateFileCount();
                showSuccess(data.message);
            } else {
                handleError('批量删除失败: ' + data.error);
            }
        })
        .catch(error => {
            handleError('批量删除时出错');
        })
        .finally(() => {
            hideDeleteModal();
        });
    }
    
    // 更新批量操作UI
    function updateBatchActionsUI() {
        const batchActions = document.getElementById('batch-actions');
        const toggleBtn = document.getElementById('toggle-selection-btn');
        const btnText = toggleBtn.querySelector('span');
        
        if (isSelectionMode) {
            batchActions.classList.remove('hidden');
            btnText.textContent = '关闭批量选择';
            
            // 显示所有复选框
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                updateSelectionMode(checkbox.parentElement, checkbox);
            });
        } else {
            batchActions.classList.add('hidden');
            btnText.textContent = '开启批量选择';
            
            // 隐藏所有复选框并重置状态
            selectedFiles = [];
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                updateSelectionMode(checkbox.parentElement, checkbox);
            });
        }
        
        updateSelectedCount();
    }
    
    // 初始化事件监听器
    function initEventListeners() {
        // 文件类型筛选按钮
        document.getElementById('filter-all').addEventListener('click', function() {
            updateFilterButtons('all');
            currentFilter = 'all';
            loadFiles();
        });
        
        document.getElementById('filter-images').addEventListener('click', function() {
            updateFilterButtons('image');
            currentFilter = 'image';
            loadFiles();
        });
        
        document.getElementById('filter-audios').addEventListener('click', function() {
            updateFilterButtons('audio');
            currentFilter = 'audio';
            loadFiles();
        });
        
        // 搜索框
        document.getElementById('file-search').addEventListener('input', function() {
            searchQuery = this.value;
            applyFilters();
        });
        
        // 批量选择切换按钮
        document.getElementById('toggle-selection-btn').addEventListener('click', function() {
            isSelectionMode = !isSelectionMode;
            updateBatchActionsUI();
        });
        
        // 取消选择按钮
        document.getElementById('cancel-selection-btn').addEventListener('click', function() {
            isSelectionMode = false;
            updateBatchActionsUI();
        });
        
        // 批量删除按钮
        document.getElementById('batch-delete-btn').addEventListener('click', function() {
            if (selectedFiles.length > 0) {
                isBatchDelete = true;
                showDeleteModal(true);
            }
        });
        
        // 分页按钮
        document.getElementById('prev-page').addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                renderFileList();
                updatePagination();
            }
        });
        
        document.getElementById('next-page').addEventListener('click', function() {
            const totalPages = Math.ceil(filteredFiles.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderFileList();
                updatePagination();
            }
        });
        
        // 删除确认对话框按钮
        document.getElementById('cancel-delete-btn').addEventListener('click', hideDeleteModal);
        
        document.getElementById('confirm-delete-btn').addEventListener('click', function() {
            if (isBatchDelete) {
                deleteMultipleFiles();
            } else {
                deleteSingleFile();
            }
        });
        
        // 点击对话框外部关闭
        document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideDeleteModal();
            }
        });
    }
    
    // 更新筛选按钮样式
    function updateFilterButtons(activeFilter) {
        const buttons = {
            'all': document.getElementById('filter-all'),
            'image': document.getElementById('filter-images'),
            'audio': document.getElementById('filter-audios')
        };
        
        Object.keys(buttons).forEach(key => {
            if (key === activeFilter) {
                buttons[key].classList.remove('bg-white', 'text-gray-700', 'hover:bg-gray-50');
                buttons[key].classList.add('bg-primary', 'text-white');
            } else {
                buttons[key].classList.remove('bg-primary', 'text-white');
                buttons[key].classList.add('bg-white', 'text-gray-700', 'hover:bg-gray-50');
            }
        });
    }
</script>
{% endblock %}